let bangleStatusColor="#f00",eSenseStatusColor="#f00";function switchStatusColor(){bangleStatusColor=bangleAccelActive?"#4f0":"#f00",eSenseStatusColor=eSenseListenerActive?"#4f0":"#f00"}function fillStatusCircleBangle(e){g.setColor(bangleStatusColor),g.fillCircle(e.x,e.y,4)}function fillStatusCircleEsense(e){g.setColor(eSenseStatusColor),g.fillCircle(e.x,e.y,4)}function loadLayout(){var e=require("Layout");return require("Font4x5").add(Graphics),new e({type:"v",c:[{type:"h",c:[{type:"v",bgCol:"#444444",c:[{type:"h",c:[{type:"txt",font:"4x5:2",label:"BANGLE",fillx:3,filly:1,col:"#fff"},{type:"custom",render:fillStatusCircleBangle,fillx:1}]},{type:"txt",font:"4x5:4",label:0,fillx:1,filly:2,col:"#fff",id:"bangle"}]},{type:"v",bgCol:"#808080",c:[{type:"h",c:[{type:"txt",font:"4x5:2",label:"ESENSE",fillx:3,filly:1,col:"#fff"},{type:"custom",render:fillStatusCircleEsense,fillx:1}]},{type:"txt",font:"4x5:4",label:0,fillx:1,filly:2,col:"#fff",id:"esense"}]}]},{type:"v",bgCol:"#000",c:[{type:"txt",font:"4x5:2",label:"ACCURATE STEPS",fillx:1,filly:1,col:"#fff"},{type:"txt",font:"4x5:4",label:0,fillx:1,filly:2,col:"#fff",id:"combined"}]}]})}let gatt,service,startedAt=parseInt(Date.now()),csv=!1,bangleCSV,eSenseCSV,eSenseSteps=0,bangleSteps=0,combinedSteps=0,eSenseLastTime=0,rssi,bangleAccelActive=!1,eSenseListenerActive=!1,mainmenu={"":{title:" - Main Menu - ",fontHeight:20},"Data Plotter":()=>{drawAccelPlot(),setWatch(()=>{g.clear(),clearInterval(),E.showMenu(mainmenu)},BTN1,{repeat:!1})},"Show Steps":()=>{g.clear(),switchStatusColor(),updateSteps();let e=loadLayout();e.render(),setWatch(()=>{clearInterval(),E.showMenu(mainmenu)},BTN1,{repeat:!1}),setInterval(()=>{switchStatusColor(),updateSteps(),e.render()},1e3)},"Bangle Config":()=>{E.showMenu(bangleMenu)},"eSense Config":()=>{gatt&&gatt.connected?E.showMenu(eSenseMenu):E.showPrompt("No eSense connected.\nTry to connect?").then(e=>{e?tryToConnectESense():E.showMenu(mainmenu)})},"Store Data":{value:csv,format:e=>e?"On":"Off",onchange:e=>{var t;e&&(t=parseInt(Date.now()/1e3),eSenseCSV=require("Storage").open("eSense_"+t+".csv","a"),bangleCSV=require("Storage").open("bangle_"+t+".csv","a")),csv=e}}};function tryToConnectESense(){E.showMessage("Connecting..."),connectToESense().then(e=>{gatt=e,console.log("Connected to eSense"),gatt.device.on("gattserverdisconnected",e=>{console.log("Disconnected due to: ",e),eSenseListenerActive=!1}),rssi=gatt.rssi,setInterval(()=>{checkRSSI()},3e3),getBLEService(gatt).then(e=>{service=e,console.log("Found primary service"),eSenseListenerActive=!1,E.showMenu(eSenseMenu),setInterval(()=>{gatt.connected?console.log("Still connected: "+rssi):(console.log("Connection lost"),clearInterval(),E.showAlert("Disconnected!").then(()=>{E.showMenu(mainmenu)}))},5e3)}).catch(e=>{console.log("Error: "+e),gatt.connected&&gatt.disconnect().then(()=>console.log("Automatically Disconnected")).catch(()=>console.log("Failed to disconnect")),E.showAlert("Connected, but failed to get the service").then(()=>{E.showMenu(mainmenu)})})}).catch(e=>{console.log("Error: "+e),E.showAlert("Failed to connect").then(()=>{E.showMenu(mainmenu)})})}function turnOffAndDisconnect(e){eSenseListenerActive=!1,turnOffSensor(e).then(()=>{console.log("Turned off sensor"),disconnectESense()}).catch(e=>{console.log(e),disconnectESense()})}function disconnectESense(){gatt&&gatt.connected&&gatt.disconnect().then(()=>console.log("Disconnected")).catch(()=>console.warn("Disconnect failed")),E.showMenu(mainmenu)}function updateSteps(){layout.bangle.label=bangleSteps,layout.esense.label=eSenseSteps,layout.combined.label=combinedSteps}let emulator=!1;try{NRF.setScan(()=>{})}catch(e){emulator=!0}emulator?(console.log("Runs in Emulator."),delete mainmenu["eSense Config"],delete mainmenu["Bangle Config"],delete mainmenu["Store Data"]):(console.log("Runs on Bangle."),delete mainmenu["Data Plotter"]),E.showMenu(mainmenu);let bangleAccelSampleRate=25,bangleAccelSensitivity=4;const bangleMenu={"":{title:" - Bangle Menu - ",fontHeight:20,back:()=>{E.showMenu(mainmenu)}},Acclerometer:{value:bangleAccelActive,format:e=>e?"On":"Off",onchange:e=>{(bangleAccelActive=e)?(startAccel(bangleAccelSampleRate,bangleAccelSensitivity),console.log("Started Bangle Accelerometer")):(stopAccel(),console.log("Stopped Bangle Accelerometer"))}},"Sample Rate":{value:bangleAccelSampleRate,min:12.5,max:50,step:12.5,onchange:e=>{bangleAccelSampleRate=37.5==e?37.5<bangleAccelSampleRate?25:50:e,console.log("Set Sample Rate of Accelerator: "+bangleAccelSampleRate),setAccelSampleRate(bangleAccelSampleRate)}},Sensitivity:{value:bangleAccelSensitivity,min:2,max:8,step:2,onchange:e=>{bangleAccelSensitivity=6==e?6<bangleAccelSensitivity?4:8:e,console.log("Set Sensitivity of Accelerator: "+bangleAccelSensitivity),setAccelSensitivity(bangleAccelSensitivity)}}};let eSenseSampleRate=25;const eSenseMenu={"":{title:" - eSense Menu - ",fontHeight:20,back:()=>{E.showMenu(mainmenu)}},Listener:{value:eSenseListenerActive,format:e=>e?"On":"Off",onchange:e=>{(eSenseListenerActive=e)&&startListener(()=>{E.showAlert(()=>{E.showMenu(eSenseMenu)})})}},"Sample Rate":{value:eSenseSampleRate,min:12.5,max:50,step:12.5,onchange:e=>{eSenseSampleRate=e,setSensorConfig(service,e).then(()=>{console.log("Set sampling rate: ",e)}).catch(e=>{console.log(e)})}},"Show Battery":()=>{E.showMessage("Waiting..."),getBatteryStatus(service).then(e=>{var e=(256*e.buffer[3]+e.buffer[4])/1e3,t=parseInt(e/4.2*100);console.log("Battery: "+e+"V"),E.showMessage("Battery Status is: "+t+"%"),setTimeout(()=>{E.showMenu(eSenseMenu)},2e3)}).catch(e=>{console.log(e),E.showAlert("No battery found").then(()=>E.showMenu(eSenseMenu))})},Disconnect:()=>{E.showMessage("Disconnecting..."),turnOffAndDisconnect(service)}};function startListener(t){E.showMessage("Starting Listener..."),setSensorConfig(service,eSenseSampleRate).then(()=>{setSensorListener(service,eSenseStepDetection).then(()=>{console.log("Started listener"),E.showMenu(eSenseMenu)}).catch(e=>{console.log(e),t()})}).catch(e=>{console.log(e),t()})}function eSenseStepDetection(e){var t,e=getMagnitude(e);calculateSteps(e,eSenseDetectionSet)&&(eSenseSteps++,eSenseLastTime=parseInt(Date.now())),csv&&(t=parseInt(Date.now())-startedAt,eSenseCSV.write(e+","+t+"\n"))}function startAccel(e,t){setAccelSensitivity(t,!0),pollAccelData(e)}function stopAccel(){Bangle.accelWr(24,10),Bangle.removeListener("accel")}function setAccelSampleRate(e){let t=0;switch(e){case 12.5:t=0;break;case 25:t=1;break;case 50:t=2;break;case 100:t=3}Bangle.accelWr(24,108),Bangle.accelWr(27,64|t)}function setAccelSensitivity(e,t){let n=0;switch(e){case 2:n=0;break;case 4:n=8;break;case 8:n=16}Bangle.accelWr(24,(t?228:100)|n)}function pollAccelData(e){Bangle.setPollInterval(1e3/e),Bangle.on("accel",accelHandler)}function accelHandler(e){bangleStepDetection(e.mag)}function bangleStepDetection(e){if(calculateSteps(e,bangleDetectionSet)){bangleSteps++,console.log(bangleSteps);const n=parseInt(Date.now());setTimeout(()=>{Math.abs(n-eSenseLastTime)<600&&(combinedSteps++,console.log("accuarate step",combinedSteps))},500)}var t;csv&&(t=parseInt(Date.now())-startedAt,bangleCSV.write(e+","+t+"\n"))}function checkRSSI(){NRF.setScan(e=>{rssi=e.rssi},{filters:[{namePrefix:"eSense"}]})}function connectToESense(){return NRF.requestDevice({filters:[{namePrefix:"eSense"}]}).then(e=>(console.log(e.gatt),e.gatt.connect({minInterval:40,maxInterval:80})))}function getBLEService(e){return e.getPrimaryService(65286)}function setSensorConfig(e,t){return e.getCharacteristic("0xFF07").then(e=>{return e.writeValue([83,3+t,2,1,t])})}function turnOffSensor(e){return e.getCharacteristic("0xFF07").then(e=>{return e.writeValue([83,2,2,0,0])})}function setSensorListener(e,n){return e.getCharacteristic("0xFF08").then(function(t){return t.on("characteristicvaluechanged",function(e){eSenseListenerActive||t.stopNotifications();e=[].slice.call(e.target.value.buffer);n(e)}),t.startNotifications()})}function getBatteryStatus(e){return e.getCharacteristic("0xFF0A").then(e=>e.readValue())}function getMagnitude(e){var t=combineBytes(e[10],e[11]),n=combineBytes(e[12],e[13]),e=combineBytes(e[14],e[15]);return calculateMagnitude(32768<t?t-65536:t,32768<n?n-65536:n,32768<e?e-65536:e)}function calculateMagnitude(e,t,n){return Math.sqrt(e*e+t*t+n*n)}function combineBytes(e,t){return e<<8|t}const slidingWindowSize=3;let bangleDetectionSet={name:"Bangle.js",slidingWindow:[],basement:1,mainThreshold:1.25,lowThreshold:.99,peakDetected:!1},eSenseDetectionSet={name:"eSense",slidingWindow:[],basement:8250,mainThreshold:9e3,lowThreshold:8e3,peakDetected:!1};function calculateSteps(e,t){t.slidingWindow.length==slidingWindowSize&&t.slidingWindow.shift(),t.slidingWindow.push(e);e=t.slidingWindow,e=e.reduce((e,t)=>e+t)/e.length;if(!t.peakDetected&&e>=t.mainThreshold)console.log(t.name+": peak reached"),t.peakDetected=!0;else if(t.peakDetected&&e<=t.lowThreshold)return t.peakDetected=!1,console.log(t.name+": full step"),!0}